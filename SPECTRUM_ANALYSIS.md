# 频谱分析技术说明

## 频谱图配置

### 频率范围
- **范围**: 0 - 100,000 Hz (0 - 100 kHz)
- **分辨率**: 基于FFT点数，2048点FFT提供约7.8Hz分辨率
- **采样率**: 16 kHz (ESP32S3 I2S配置)

### 坐标系统

#### Y轴 (幅度)
- **单位**: dB (分贝)
- **坐标**: 对数坐标
- **参考**: 0dB = 最大幅度
- **范围**: 通常 -60dB 到 0dB

#### X轴 (频率)
- **单位**: Hz (赫兹)
- **坐标**: 线性坐标
- **范围**: 0 - 100,000 Hz

### 技术实现

#### 1. 窗函数
```python
window = np.hanning(len(recent_data))
windowed_data = recent_data * window
```
- 使用汉宁窗减少频谱泄漏
- 改善频率分辨率

#### 2. FFT计算
```python
fft_data = np.fft.fft(windowed_data)
freq_data = np.fft.fftfreq(len(recent_data), 1/16000)
```
- 2048点FFT
- 16kHz采样率

#### 3. dB转换
```python
fft_data = np.maximum(fft_data, 1e-10)  # 避免log(0)
fft_db = 20 * np.log10(fft_data)
fft_db = fft_db - np.max(fft_db)  # 归一化到0dB
```

### 音频频率参考

| 频率范围 | 描述 | 应用 |
|---------|------|------|
| 20-60 Hz | 超低频 | 次声波 |
| 60-250 Hz | 低频 | 低音鼓、贝斯 |
| 250-2000 Hz | 中频 | 人声、乐器 |
| 2000-8000 Hz | 高频 | 高音、细节 |
| 8000-20000 Hz | 超高频 | 泛音、空气感 |
| 20000+ Hz | 超声波 | 超出人耳范围 |

### 显示优化

#### 对数坐标的优势
1. **动态范围**: 可以同时显示很弱和很强的信号
2. **人耳特性**: 符合人耳的对数响应特性
3. **细节显示**: 弱信号也能清晰显示

#### 频率分辨率
- **2048点FFT**: 7.8Hz分辨率
- **1024点FFT**: 15.6Hz分辨率
- **512点FFT**: 31.25Hz分辨率

### 性能考虑

#### 计算复杂度
- FFT: O(n log n)
- 窗函数: O(n)
- dB转换: O(n)

#### 实时性
- 建议更新频率: 10-20 FPS
- 数据缓冲区: 2048样本
- 处理延迟: ~128ms (2048/16000)

### 扩展功能建议

#### 1. 频谱平均
```python
# 多次FFT平均，减少噪声
averaged_spectrum = np.mean(spectra_array, axis=0)
```

#### 2. 峰值检测
```python
# 检测频谱峰值
peaks = find_peaks(fft_db, height=-20, distance=10)
```

#### 3. 频率标记
```python
# 标记特定频率
for freq in [440, 880, 1760]:  # A4, A5, A6
    mark_frequency(freq)
```

### 调试信息

#### 频谱质量指标
- **信噪比**: 峰值与噪声底部的差值
- **频率精度**: 实际频率与显示频率的偏差
- **动态范围**: 最强与最弱信号的差值

#### 常见问题
1. **频谱泄漏**: 使用窗函数解决
2. **频率混叠**: 确保采样率足够高
3. **噪声**: 增加平均次数或使用滤波器 